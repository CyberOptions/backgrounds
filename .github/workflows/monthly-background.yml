name: Monthly Background Generator (Fully Automated)

on:
  schedule:
    # 7:00 AM America/Toronto across DST (11 & 12 UTC)
    - cron: "0 11 1 * *"
    - cron: "0 12 1 * *"
  workflow_dispatch:

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install openai pillow pytz requests

      - name: Generate and resize monthly background
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - <<'PY'
          import os, datetime, base64, pytz, io
          import requests
          from PIL import Image

          # --- Date setup ---
          tz = pytz.timezone("America/Toronto")
          now = datetime.datetime.now(tz)
          month_en = now.strftime("%B")
          month_fr = now.strftime("%B").capitalize()
          year = now.strftime("%Y")
          filename = f"{month_en}-{year}.png"

          # --- Prompt ---
          prompt = (
              f"Ultra-realistic 4K digital photograph of a nature landscape representing {month_fr} {year}, "
              f"with a wooden sign showing '{month_fr} {year}' in French, matching the seasonal mood in Canada, "
              f"natural lighting, photorealistic, cinematic tone."
          )

# --- Generate image ---
print(f"Generating background for {month_fr} {year} ...")

response = requests.post(
    "https://api.openai.com/v1/images/generations",
    headers={
        "Authorization": f"Bearer {os.environ['OPENAI_API_KEY']}",
        "Content-Type": "application/json",
    },
    json={
        "model": "dall-e-3",  # ✅ Correct model name
        "prompt": prompt,
        "size": "1024x1024",
        "n": 1,
    },
)

data = response.json()

# --- Handle API errors gracefully ---
if "error" in data:
    print("❌ OpenAI API error:", data["error"]["message"])
    raise SystemExit(1)

b64_img = data["data"][0]["b64_json"]
img_data = base64.b64decode(b64_img)
img = Image.open(io.BytesIO(img_data)).convert("RGB")


          # --- Resize to 1024x633 ---
          img = img.resize((1024, 633))
          img.save(filename, format="PNG")
          print("✅ Image saved:", filename)
          PY

      - name: Commit and push background
        run: |
          month=$(TZ=America/Toronto date +"%B")
          year=$(TZ=America/Toronto date +"%Y")
          filename="${month}-${year}.png"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$filename" || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Add $filename background (auto-generated)"
            git push
          fi
